<div class="bg-white p-6 rounded-xl shadow-md max-w-4xl mx-auto">
    <h2 class="text-xl font-semibold mb-6 border-b pb-4"><?= e($title); ?></h2>
    <?php if (!empty($error)): ?>
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
            <span class="block sm:inline"><?= e($error); ?></span>
        </div>
    <?php endif; ?>
    <form action="<?= APP_URL; ?>/orders/update" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="id" value="<?= e($order->id); ?>">
        <input type="hidden" name="current_image" value="<?= e($order->image); ?>">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="user_id" class="block text-sm font-medium text-gray-700 mb-1">انتخاب مشتری <span class="text-red-500">*</span></label>
                <select name="user_id" id="user_id" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <?php foreach ($customers as $customer): ?>
                        <option value="<?= e($customer->id); ?>" <?= ($order->user_id == $customer->id) ? 'selected' : ''; ?>><?= e($customer->full_name); ?></option>
                    <?php endforeach; ?>
                </select>
            </div>
            <div>
                <label for="title" class="block text-sm font-medium text-gray-700 mb-1">عنوان سفارش <span class="text-red-500">*</span></label>
                <input type="text" name="title" id="title" value="<?= e($order->title); ?>" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label for="source_site" class="block text-sm font-medium text-gray-700 mb-1">سایت مبدا</label>
                <select name="source_site" id="source_site" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <option value="">انتخاب سایت...</option>
                    <?php foreach ($sites as $site): ?>
                        <option value="<?= e($site->url); ?>" <?= ($order->source_site == $site->url) ? 'selected' : ''; ?>><?= e($site->name); ?></option>
                    <?php endforeach; ?>
                </select>
            </div>
             <!-- FIX: Added Product Link Input Field -->
            <div>
                <label for="product_link" class="block text-sm font-medium text-gray-700 mb-1">لینک محصول</label>
                <input type="url" name="product_link" id="product_link" value="<?= e($order->product_link ?? ''); ?>" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="https://www.example.com/product-page">
            </div>
            <div>
                <label for="category_id" class="block text-sm font-medium text-gray-700 mb-1">دسته‌بندی</label>
                <select name="category_id" id="category_id" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <option value="">بدون دسته‌بندی</option>
                    <?php foreach ($categories as $category): ?>
                        <option value="<?= e($category->id); ?>" <?= ($order->category_id == $category->id) ? 'selected' : ''; ?>><?= e($category->name); ?></option>
                    <?php endforeach; ?>
                </select>
            </div>
            <div>
                <label for="image" class="block text-sm font-medium text-gray-700 mb-1">تصویر جدید (اختیاری)</label>
                <input type="file" name="image" id="image" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
            <div>
                <label for="price_lira" class="block text-sm font-medium text-gray-700 mb-1">قیمت (لیر)</label>
                <input type="number" step="0.01" name="price_lira" id="price_lira" value="<?= e($order->price_lira); ?>" class="w-full px-4 py-2 border border-gray-300 rounded-lg" oninput="convertToToman()">
                <p class="text-xs text-gray-500 mt-1">نرخ فعلی لیر: <span id="liraRateText"><?= number_format($current_lira_rate ?? 0); ?></span> تومان</p>
            </div>
            <div>
                <label for="price_toman" class="block text-sm font-medium text-gray-700 mb-1">قیمت (تومان)</label>
                <input type="number" step="1" name="price_toman" id="price_toman" value="<?= e($order->price_toman); ?>" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">تعداد</label>
                <input type="number" name="quantity" id="quantity" value="<?= e($order->quantity); ?>" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label for="size" class="block text-sm font-medium text-gray-700 mb-1">سایز</label>
                <input type="text" name="size" id="size" value="<?= e($order->size); ?>" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label for="weight" class="block text-sm font-medium text-gray-700 mb-1">وزن (کیلوگرم)</label>
                <input type="number" step="0.01" name="weight" id="weight" value="<?= e($order->weight); ?>" class="w-full px-4 py-2 border border-gray-300 rounded-lg" oninput="recalcWeightedCosts()">
            </div>

            <!-- نرخ‌ها -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">نرخ باربری (تومان/کیلو)</label>
                <select name="shipping_rate_id" id="shipping_rate_id" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="recalcWeightedCosts()">
                    <option value="">انتخاب نرخ...</option>
                    <?php foreach (($shipping_rates ?? []) as $r): ?>
                        <option value="<?= e($r->id); ?>" data-amount="<?= e($r->amount_toman); ?>" <?= ($order->shipping_rate_id == $r->id ? 'selected' : ''); ?>><?= e($r->title); ?> - <?= number_format($r->amount_toman); ?> تومان/کیلو</option>
                    <?php endforeach; ?>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">نرخ کارگو (تومان/کیلو)</label>
                <select name="cargo_rate_id" id="cargo_rate_id" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="recalcWeightedCosts()">
                    <option value="">انتخاب نرخ...</option>
                    <?php foreach (($cargo_rates ?? []) as $r): ?>
                        <option value="<?= e($r->id); ?>" data-amount="<?= e($r->amount_toman); ?>" <?= ($order->cargo_rate_id == $r->id ? 'selected' : ''); ?>><?= e($r->title); ?> - <?= number_format($r->amount_toman); ?> تومان/کیلو</option>
                    <?php endforeach; ?>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">نرخ خرید استور (تومان/کیلو)</label>
                <select name="store_rate_id" id="store_rate_id" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="recalcWeightedCosts()">
                    <option value="">انتخاب نرخ...</option>
                    <?php foreach (($store_rates ?? []) as $r): ?>
                        <option value="<?= e($r->id); ?>" data-amount="<?= e($r->amount_toman); ?>" <?= ($order->store_rate_id == $r->id ? 'selected' : ''); ?>><?= e($r->title); ?> - <?= number_format($r->amount_toman); ?> تومان/کیلو</option>
                    <?php endforeach; ?>
                </select>
            </div>

            <!-- پیش‌نمایش هزینه‌ها -->
            <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-4 gap-4 bg-gray-50 p-4 rounded-lg">
                <div>محصول: <span id="preview_product" class="font-semibold">0</span></div>
                <div>باربری: <span id="preview_shipping" class="font-semibold">0</span></div>
                <div>کارگو: <span id="preview_cargo" class="font-semibold">0</span></div>
                <div>استور: <span id="preview_store" class="font-semibold">0</span></div>
                <div class="md:col-span-4 border-t pt-2">جمع کل: <span id="preview_total" class="font-bold text-green-600">0</span> تومان</div>
            </div>
            <div class="md:col-span-2">
                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">توضیحات</label>
                <textarea name="description" id="description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg"><?= e($order->description); ?></textarea>
            </div>
            <div class="md:col-span-2 flex items-center space-x-4 space-x-reverse">
                <div class="flex items-center">
                    <input id="apply_shipping" name="apply_shipping" type="checkbox" value="1" class="h-4 w-4 text-blue-600" <?= $order->apply_shipping ? 'checked' : ''; ?>><label for="apply_shipping" class="mr-2 block text-sm">اعمال هزینه باربری</label>
                </div>
                <div class="flex items-center">
                    <input id="with_cargo" name="with_cargo" type="checkbox" value="1" class="h-4 w-4 text-blue-600" <?= $order->with_cargo ? 'checked' : ''; ?>><label for="with_cargo" class="mr-2 block text-sm">با کارگو</label>
                </div>
                <div class="flex items-center">
                    <input id="is_store_purchase" name="is_store_purchase" type="checkbox" value="1" class="h-4 w-4 text-blue-600" <?= $order->is_store_purchase ? 'checked' : ''; ?>><label for="is_store_purchase" class="mr-2 block text-sm">خرید استور</label>
                </div>
            </div>
        </div>
        <div class="mt-8 pt-5 border-t flex justify-end">
            <a href="<?= APP_URL; ?>/orders" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 ml-4">انصراف</a>
            <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">به‌روزرسانی</button>
        </div>
    </form>
</div>

<script>
    function toNumber(val) { var n = parseFloat(val); return isNaN(n) ? 0 : n; }
    function convertToToman() {
        var lira = toNumber(document.getElementById('price_lira').value);
        var rate = toNumber((document.getElementById('liraRateText').innerText || '').replace(/\D/g, ''));
        if (lira > 0 && rate > 0) {
            document.getElementById('price_toman').value = Math.round(lira * rate);
        }
        recalcWeightedCosts();
    }
    function recalcWeightedCosts() {
        var weight = toNumber(document.getElementById('weight').value);
        function selectedAmount(id) {
            var el = document.getElementById(id);
            if (!el) return 0;
            var opt = el.options[el.selectedIndex];
            return opt ? toNumber(opt.getAttribute('data-amount')) : 0;
        }
        var product = toNumber(document.getElementById('price_toman').value);
        var shipping = weight * selectedAmount('shipping_rate_id');
        var cargo = weight * selectedAmount('cargo_rate_id');
        var store = weight * selectedAmount('store_rate_id');
        var total = product + shipping + cargo + store;
        function nf(x){ return (Math.round(x)).toLocaleString('fa-IR'); }
        document.getElementById('preview_product').innerText = nf(product);
        document.getElementById('preview_shipping').innerText = nf(shipping);
        document.getElementById('preview_cargo').innerText = nf(cargo);
        document.getElementById('preview_store').innerText = nf(store);
        document.getElementById('preview_total').innerText = nf(total);
    }
    recalcWeightedCosts();
</script>
